# Сервис Subscribe/Publish

## Запуск

1) Создать `.env`.
```shell
cp .env.example .env
```
2) Запустить контейнер с сервисом.
```shell
docker compose up
```

## Использование

Чтобы проверить функционал сервиса, можно воспользоваться утилитой `Postman`.\
Данный сервис поддерживает две удаленные процедуры:

1) Subscribe (key) – подписывает клиента на топик с названием `key`.
2) Publish (key, data) – отправляет в топик с названием `key` сообщение `data`.

## Принцип работы
Структура проекта:

├── cmd
│   └── main.go                     # точка входа в программу
├── config
│   └── dev.yaml                    # конфиг файл
├── contracts
│   └── subpub.proto                # контракт взаимодействия по grpc
├── docker-compose.yaml
├── Dockerfile
├── go.mod
├── go.sum
├── internal
│   ├── app
│   │   └── app.go                  # приложение для запуска сервиса
│   ├── config
│   │   └── config.go               # чтение и сборка конфига
│   ├── gen                         # сгенерированные файлы grpc
│   │   └── go
│   │       ├── subpub_grpc.pb.go
│   │       └── subpub.pb.go
│   ├── grpc
│   │   └── subpub
│   │       └── subpub.go           # grpc сервис
│   └── services
│       └── subpub
│           └── subpub.go           # subpub модуль, который реализует функционал подписки и публикации сообщений
├── README.md
├── Taskfile.yml
└── tests
    ├── subpub_test.go              # тесты модуля subpub
    └── suite
        └── suite.go


В services/subpub реализуется механизм подписки и публикации сообщений.
1) При вызове Subscribe создается объект типа Subscription, у которого есть своя очередь с сообщениями, callback функция и waitGroup для ожидания всех воркеров.
2) При вызове Publish мы проходимся по всем подписчикам канала и кладем сообщение, если очередь переполнена, то пропускаем.

В grpc/subpub реализован механизм взаимодействия через gRPC.
1) В Subscribe создается новый подписчик с callback, который передает сообщение по stream.
2) В Publish вызывется метод из модуля subpub, который кладет сообщение подписчикам канала.

В app/app.go реализован запуск сервиса и его Graceful Shutdown.\
Если по истечению заданного времени (в текущей реализации 5 сек.) сервер не выключается, то он завершает свою работу принудительно.
Также в сервисе настроено логирование.
